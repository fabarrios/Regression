---
title: "Analyzing Longitudinal Data"
author: "F.A.Barrios"
date: "2025-11-07"
output:
  rmdformats::robobook:
    highlight: kate
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
# knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig_width=8,
               fig_height=6)
```

```{r}
# Loading libraries
library(tidyverse)
library(HSAUR3)
library(lme4)
library(multcomp)

```

These notes are taken from the Handbook of Statistical Analyses Using R, Third edition (HSAUR3 package)

## Beat the Blues example

Data of a longitudinal study distinguishes itself because the response variable of interest and the predictor variables are measured several times on each individual in the study. The principal objective of such study is to characterize change in the repeated values of the response variable and to determine the predictors most associated with any change.

BtheB data from the HSAUR3 package has the Beat the Blues study designed to deliver cognitive behavioral therapy (CBT) by computer terminal and compare how effective are the regular treatment: Treatment as Usual (TAU) with the cognitive behavioral therapy by computer: Beat the Blues (BtheB) in depressed patients evaluated with the Beck Depression Inventory II (BID), prior to treatment. Two months after treatment began, and following them at three, five, and eight months after treatment.


## Linear Mixed Effects Models

The distinguishing feature of a longitudinal study is that the responce function and the set of predictors are measured several times on each individual in the study. Therefore the objective in these models is to characterize the change in the response function and the predictor variables most associated with any change.
Linear mixed effects models for repeated measures data formalize the important analysis with the idea that the responses pattern of a given individual in time, depend in the individual's characteristics, including some that are not observed. These unobserved variables than are included as random variables in the model (i.e., random effects). There are two common linear mixed effects models, the *random intercept* and the *random intercept and slope* models.

## Linear Mixed Effects Models in R

We will start making a plot of the data

```{r}
data("BtheB", package = "HSAUR3")

layout(matrix(1:2, nrow = 1))
ylim <- range(BtheB[, grep("bdi", names(BtheB))], na.rm = TRUE)

tau <- subset(BtheB, treatment == "TAU")[, grep("bdi", names(BtheB))]
boxplot(tau, main = "Treated as Usual", ylab = "BDI", xlab = "Time (in months)", names = c(0, 2, 3, 5, 8), ylim = ylim)

btheb <- subset(BtheB, treatment == "BtheB")[, grep("bdi", names(BtheB))]
boxplot(btheb, main = "Beat the Blues", ylab = "BDI", xlab = "Time (in months)", names = c(0, 2, 3, 5, 8), ylim = ylim)

```
## Data wrangling

`BtheB` data is loaded in a table format (wide form) and requires to be reshaped in long format leaving some of the predictors untouched like the initial Beck Depression Inventory II (bdi.pre) score and the predictors that remain unchanged: drug, length, and treatment which should be paired with each of the follow-up BDI results at two, three, five, and eight months. 

```{r}
nobs <- nrow(BtheB)

BtheB <- as_tibble(BtheB)
BtheB <- BtheB %>% mutate(subject = factor(rownames(BtheB)))

BtheB_long <- BtheB %>%
  pivot_longer(cols = c(bdi.2m, bdi.3m, bdi.5m, bdi.8m), names_to = "bdi", values_to = "BDI_score")

BtheB_long <- BtheB_long %>% 
  mutate(follow_up = rep(c(2, 3, 5, 8), each = 1, times = nobs) )

head(BtheB_long, 16)

```

## Model fitting with lme4 package

We will fit both random intercept and random intercept and slope models, we will include the baseline BDI score, treatment group, drug, and length as *fixed effect covariables*. We will fit linear mixed effects models with the `lmer` function from the **lme4** package. We have transformed the `BtheB` data frame in the long format. Since there are a number of missing values we will apply the `lmer` function with the NA drop option. The random term identified as subject.  


```{r}
BtheB_lmer1 <- lmer(BDI_score ~ bdi.pre + drug + length + treatment +
                    follow_up + (1 | subject), data = BtheB_long,
                    REML = FALSE, na.action = na.omit)

BtheB_lmer2 <- lmer(BDI_score ~ bdi.pre + drug + length + treatment +
                    follow_up + (follow_up | subject), data = BtheB_long,
                    REML = FALSE, na.action = na.omit)

anova(BtheB_lmer1, BtheB_lmer2)
```

The log-likelihood test `anova()` indicates that the simpler random intercept model is adequate for these data. More information about the random model intercept is listed using the `summary(BtheB_lmer1)`. The `lmer()` function does not list the the p-values for Gaussian mixed models because the degrees of freedom of the *t* reference distribution are not obvious. The `cftest` from the `multicomp` package estimates the asymptotic normal distribution for computing univariate p-values for the fixed effects.  

```{r}
summary(BtheB_lmer1)

cftest(BtheB_lmer1)
```

To estimate the assumptions of the final model fitted to the `BtheB`data. i.e. the normality of the random effect terms and the residuals, the former can be estimated by using the `ranef` method to *predict* their values and the `residuals` to calculate the differences between the observed data values and the fitted values, and then using normal provability plots for both.  

```{r}
layout(matrix(1:2, ncol = 2))
qint <- ranef(BtheB_lmer1)$subject[["(Intercept)"]]
qres <- residuals(BtheB_lmer1)

qqnorm(qint, ylab = "Estimated ramdom intercepts",
       xlim = c(-3, 3), ylim = c(-20, 20),
       main = "Random intercepts")
qqline(qint)
qqnorm(qres, ylab = "Estimated residuals",
       xlim = c(-3, 3), ylim = c(-20, 20),
       main = "Residuals")
qqline(qres)

```

There appear to be no large departure from linearity in either plot.  

## More examples

Ex 13.4 HSAUR3. The phosphate data in `phosphate` database include the plasma inorganic phosphate levels for 33 subjects, 20 of whom are control, and 13 of whom are have been classified as obese. Fit a sensible linear mixed effects model to the data.  

Plotting the two groups data in time.  
```{r}
data("phosphate")

nobs <- nrow(phosphate)
ylim <- range(phosphate[, grep("t", names(phosphate))], na.rm = TRUE)
layout(matrix(1:2, ncol = 2))

contr <- subset(phosphate, group == "control")[, grep("t", names(phosphate))]
obese <- subset(phosphate, group == "obese")[, grep("t", names(phosphate))]

boxplot(contr , main = "Controls", ylab = "Phosphate levels", xlab = "Time points", ylim = ylim)
boxplot(obese , main = "Obese", ylab = "Phosphate levels", xlab = "Time points", ylim = ylim)

```

To estimate the linear mixed effects models the data must have the adequate format to fit the `lmer` function.  

```{r}
phosphate <- phosphate %>% mutate(subject = factor(rownames(phosphate)))

phosphate_long <- phosphate %>% 
  pivot_longer(cols = c(t0.5, t1, t1.5, t2, t3, t4, t5), names_to = "time", values_to = "phosphate")

phosphate_long <- phosphate_long %>% 
  mutate(follow_up = rep(c(1, 2, 3, 4, 5, 6, 7), each = 1, times = nobs) )

head(phosphate_long, 14)
```

## Model fitting with lme4 package.  

We will fit both random intercept and random intercept and slope models, we will include the baseline `t0` of the plasma phosphate level, the group (control or obese), and the seven follow-up times.  We will compare the two models with the `anova` function. 

```{r}
phosphate_lmer1 <- lmer(phosphate ~ group + t0 +
                    follow_up + (1 | subject), data = phosphate_long,
                    REML = FALSE, na.action = na.omit,
                    control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 20000)))

phosphate_lmer2 <- lmer(phosphate ~ group + t0 +
                        follow_up + (follow_up | subject), data = phosphate_long, 
                        REML = FALSE, na.action = na.omit, 
                        control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 20000)))

anova(phosphate_lmer1, phosphate_lmer2)
```

The log-likelihood test `anova()` indicates that the simpler random intercept model and the more complex random intercept and slope model are different. More information about the random model intercept is listed using the summary of the estimated models. To estimate the p-values for Gaussian mixed models `cftest` estimates the asymptotic normal distribution for computing univariate p-values for the fixed effects.  

```{r}
# For the random intercept model
summary(phosphate_lmer1)
cftest(phosphate_lmer1)

# For the more complex model
summary(phosphate_lmer2)
cftest(phosphate_lmer2)

```
